---
title: "Autism Spectrum Disorders (F84)"
author:
  - name: "Amaru Simón Agüero Jiménez"
    email: "a.agueroj@udd.cl"
    orcid: "0000-0001-7336-1833"
date: "today"
format:
  html:
    embed-resources: false
    smooth-scroll: true
    toc: true
    toc-depth: 6
    toc-location: right
    number-sections: true
    number-depth: 6
    code-fold: true
    theme: cosmo
    fig-cap-location: bottom
execute:
  warning: false
  message: false
  fig-width: 12
  fig-height: 10
---

# Results - Autism Spectrum Disorders (F84) Analysis

```{python}
#| label: setup
#| include: false

import sys
import subprocess
import importlib
from subprocess import DEVNULL

def _pip_install(requirement: str):
    subprocess.check_call([sys.executable, "-m", "pip", "install", "--upgrade", requirement],
                          stdout=DEVNULL, stderr=DEVNULL)

try:
    from packaging.requirements import Requirement
except Exception:
    _pip_install("packaging")
    from packaging.requirements import Requirement

def ensure(requirement: str, import_name: str = None):
    req = Requirement(requirement)
    name = import_name or req.name
    try:
        mod = importlib.import_module(name)
        ver = getattr(mod, "__version__", None)
        if ver is not None and req.specifier and not req.specifier.contains(ver, prereleases=True):
            raise ImportError()
        return mod
    except Exception:
        _pip_install(requirement)
        return importlib.import_module(name)

ensure("numpy")
ensure("scipy")
ensure("pandas>=2.0.0", "pandas")
ensure("pyarrow>=10.0.0", "pyarrow")
ensure("matplotlib")
ensure("seaborn")
ensure("requests")
ensure("geopandas")
ensure("libpysal")
ensure("esda")
ensure("splot")

import pandas as pd
import numpy as np
import os
import glob
import warnings
import matplotlib.pyplot as plt
import seaborn as sns
import geopandas as gpd
from IPython.display import display

warnings.filterwarnings('ignore')
plt.rcParams['figure.dpi'] = 100
plt.rcParams['savefig.dpi'] = 150
sns.set_style("whitegrid")
pd.set_option('display.max_columns', None)
pd.set_option('display.precision', 2)

base_path = os.path.dirname(os.getcwd())
data_path = os.path.join(base_path, 'data')
output_path = os.path.join(base_path, 'output_files')
figures_path = os.path.join(output_path, 'figures')

os.makedirs(output_path, exist_ok=True)
os.makedirs(figures_path, exist_ok=True)
```

```{python}
#| label: constants
#| include: false

WHO_STANDARD_POPULATION = {
    '0-4': 8860, '5-9': 8690, '10-14': 8600, '15-19': 8470,
    '20-24': 8220, '25-29': 7930, '30-34': 7610, '35-39': 7150,
    '40-44': 6590, '45-49': 6040, '50-54': 5370, '55-59': 4550,
    '60-64': 3720, '65-69': 2960, '70-74': 2210, '75-79': 1520,
    '80+': 1540
}

TOTAL_WHO_WEIGHT = sum(WHO_STANDARD_POPULATION.values())

ASD_CODES_F84 = {
    'F84': 'Pervasive developmental disorders',
    'F84.0': 'Childhood autism',
    'F84.1': 'Atypical autism',
    'F84.2': 'Rett syndrome',
    'F84.3': 'Other childhood disintegrative disorder',
    'F84.4': 'Overactive disorder with mental retardation and stereotyped movements',
    'F84.5': 'Asperger syndrome',
    'F84.8': 'Other pervasive developmental disorders',
    'F84.9': 'Pervasive developmental disorder, unspecified'
}

ALL_ASD_CODES = ASD_CODES_F84.copy()
F84_CODES_LIST = ['F84', 'F84.0', 'F84.1', 'F84.2', 'F84.3', 'F84.4', 'F84.5', 'F84.8', 'F84.9']

AGE_GROUPS_TUPLES = [
    (0, 4), (5, 9), (10, 14), (15, 19), (20, 24), (25, 29),
    (30, 34), (35, 39), (40, 44), (45, 49), (50, 54), (55, 59),
    (60, 64), (65, 69), (70, 74), (75, 79)
]

AGE_ORDER = ['0-4', '5-9', '10-14', '15-19', '20-24', '25-29', '30-34', '35-39', 
             '40-44', '45-49', '50-54', '55-59', '60-64', '65-69', '70-74', '75-79', '80+']

YEARS = [2019, 2020, 2021, 2022, 2023, 2024]

EXCLUDED_COMUNAS = [
    'ISLA DE PASCUA', 'JUAN FERNANDEZ', 'ANTARTICA', 
    'CABO DE HORNOS', 'CABO DE HORNOS Y ANTARTICA'
]

REGION_CODES = {
    15: 'Arica y Parinacota',
    1: 'Tarapacá',
    2: 'Antofagasta',
    3: 'Atacama',
    4: 'Coquimbo',
    5: 'Valparaíso',
    13: 'Metropolitana',
    6: "O'Higgins",
    7: 'Maule',
    16: 'Ñuble',
    8: 'Biobío',
    9: 'La Araucanía',
    14: 'Los Ríos',
    10: 'Los Lagos',
    11: 'Aysén',
    12: 'Magallanes'
}

def is_excluded_comuna(comuna_name):
    if pd.isna(comuna_name):
        return False
    comuna_upper = str(comuna_name).upper().strip()
    comuna_norm = normalize_comuna(comuna_upper)
    for exc in EXCLUDED_COMUNAS:
        if exc in comuna_upper or exc in comuna_norm:
            return True
    return False
```

```{python}
#| label: functions
#| include: false

def assign_age_group(age):
    if pd.isna(age) or age is None:
        return None
    try:
        age = int(float(age))
    except (ValueError, TypeError):
        return None
    if age < 0:
        return None
    if age >= 80:
        return '80+'
    for start, end in AGE_GROUPS_TUPLES:
        if start <= age <= end:
            return f"{start}-{end}"
    return None


def parse_date(date_str, year=None):
    if pd.isna(date_str) or date_str == '':
        return pd.NaT
    date_str = str(date_str).strip()
    for fmt in ['%Y-%m-%d', '%d-%m-%Y']:
        try:
            return pd.to_datetime(date_str, format=fmt)
        except:
            pass
    try:
        return pd.to_datetime(date_str)
    except:
        return pd.NaT


def calculate_age(birth_date_str, admission_date_str, year=None):
    birth_date = parse_date(birth_date_str)
    admission_date = parse_date(admission_date_str, year)
    if pd.isna(birth_date) or pd.isna(admission_date):
        return None
    age = (admission_date - birth_date).days / 365.25
    if age < 0 or age > 120:
        return None
    return int(round(age))


def is_valid_f84_code(code_str):
    if pd.isna(code_str) or code_str == '':
        return False, None
    code = str(code_str).upper().strip().replace('.', '')
    code_3char = code[:3]
    if code_3char == 'F84':
        if len(code) >= 4:
            subcode = code[:4]
            if subcode in ['F840', 'F841', 'F842', 'F843', 'F844', 'F845', 'F848', 'F849']:
                return True, f'F84.{code[3]}'
        return True, 'F84'
    return False, None


def get_f84_codes_from_row(row, diag_cols):
    codes_found = set()
    for col in diag_cols:
        v = row.get(col)
        is_valid, code_group = is_valid_f84_code(v)
        if is_valid:
            codes_found.add(code_group)
    return codes_found


def normalize_comuna(x):
    if pd.isna(x):
        return None
    s = str(x).upper().strip()
    replacements = {'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U', 'Ñ': 'N',
                    'á': 'A', 'é': 'E', 'í': 'I', 'ó': 'O', 'ú': 'U', 'ñ': 'N'}
    for old, new in replacements.items():
        s = s.replace(old, new)
    return s


def load_and_filter_f84_data(years=YEARS, chunksize=100000):
    all_records = []
    for year in years:
        pattern = f"GRD_PUBLICO_*{year}*.csv"
        files = glob.glob(os.path.join(data_path, pattern))
        if not files:
            continue
        for chunk in pd.read_csv(files[0], delimiter='|', dtype=str, 
                                  low_memory=False, chunksize=chunksize):
            diag_cols = [col for col in chunk.columns if col.startswith('DIAGNOSTICO')]
            if not diag_cols:
                continue
            for _, row in chunk.iterrows():
                codes_found = get_f84_codes_from_row(row, diag_cols)
                if not codes_found:
                    continue
                age = calculate_age(row.get('FECHA_NACIMIENTO'), row.get('FECHA_INGRESO'), year)
                sex_val = str(row.get('SEXO', '')).strip().upper()
                sex = 'Male' if sex_val in ['1', 'HOMBRE'] else ('Female' if sex_val in ['2', 'MUJER'] else None)
                age_group = assign_age_group(age)
                for code in codes_found:
                    all_records.append({
                        'year': year,
                        'age': age,
                        'age_group': age_group,
                        'sex': sex,
                        'icd_code': code
                    })
    if not all_records:
        return pd.DataFrame(columns=['year', 'age', 'age_group', 'sex', 'icd_code', 'hospitalizations'])
    df = pd.DataFrame(all_records)
    df_counts = df.groupby(['year', 'age_group', 'sex', 'icd_code']).size().reset_index(name='hospitalizations')
    return df_counts


def _normalize_txt(x):
    if pd.isna(x):
        return None
    s = str(x).strip().lower()
    repl = str.maketrans({'á': 'a', 'é': 'e', 'í': 'i', 'ó': 'o', 'ú': 'u', 'ñ': 'n'})
    return s.translate(repl)


def _standardize_sex(x):
    if pd.isna(x):
        return None
    v = _normalize_txt(x)
    if v is None:
        return None
    v = v.replace('.', '').replace('-', ' ').replace('_', ' ').strip()
    if v in {'1', 'm', 'male', 'masculino', 'hombre', 'hombres', 'varon', 'varones'}:
        return 'Male'
    if v in {'2', 'f', 'female', 'femenino', 'mujer', 'mujeres'}:
        return 'Female'
    return None


def _find_first_existing(paths):
    for p in paths:
        if p and os.path.exists(p):
            return p
    return None


PARQUET_TO_STANDARD_REGION = {
    'Arica y Parinacota': 'Arica y Parinacota',
    'Tarapacá': 'Tarapacá',
    'Antofagasta': 'Antofagasta',
    'Atacama': 'Atacama',
    'Coquimbo': 'Coquimbo',
    'Valparaíso': 'Valparaíso',
    'Metropolitana de Santiago': 'Metropolitana',
    "Libertador General Bernardo O'Higgins": "O'Higgins",
    'Maule': 'Maule',
    'Ñuble': 'Ñuble',
    'Biobío': 'Biobío',
    'La Araucanía': 'La Araucanía',
    'Los Ríos': 'Los Ríos',
    'Los Lagos': 'Los Lagos',
    'Aysén del General Carlos Ibáñez del Campo': 'Aysén',
    'Magallanes y de la Antártica Chilena': 'Magallanes'
}


def normalize_region_to_standard(region_name):
    if pd.isna(region_name):
        return None
    name = str(region_name).strip()
    return PARQUET_TO_STANDARD_REGION.get(name, name)


def load_population_data(years=YEARS):
    candidate_paths = [
        os.path.join(data_path, 'censo_proyecciones_ano_edad_genero.parquet'),
        os.path.join(data_path, 'censo_proyecciones_año_edad_genero.parquet'),
        os.path.join(base_path, 'censo_proyecciones_ano_edad_genero.parquet'),
        os.path.join(base_path, 'censo_proyecciones_año_edad_genero.parquet'),
    ]
    pop_file = _find_first_existing(candidate_paths)
    if pop_file is None:
        patterns = [os.path.join(data_path, '**', 'censo_proyecciones*edad_genero*.parquet')]
        matches = []
        for pat in patterns:
            matches.extend(glob.glob(pat, recursive=True))
        pop_file = matches[0] if matches else None
    if pop_file is None:
        raise FileNotFoundError("Population projections file not found.")
    df = pd.read_parquet(pop_file, engine="pyarrow")
    df.columns = [str(c).strip() for c in df.columns]
    cols_norm = {_normalize_txt(c): c for c in df.columns}
    year_col = cols_norm.get('ano') or cols_norm.get('anio') or cols_norm.get('year')
    age_col = cols_norm.get('edad') or cols_norm.get('age')
    sex_col = cols_norm.get('genero') or cols_norm.get('sexo') or cols_norm.get('sex')
    pop_col = cols_norm.get('poblacion') or cols_norm.get('population')
    region_col = cols_norm.get('region')
    comuna_col = cols_norm.get('comuna')
    keep_cols = [year_col, age_col, sex_col, pop_col]
    if region_col:
        keep_cols.append(region_col)
    if comuna_col:
        keep_cols.append(comuna_col)
    pop = df[keep_cols].copy()
    rename_map = {year_col: 'year', age_col: 'age', sex_col: 'sex', pop_col: 'population'}
    if region_col:
        rename_map[region_col] = 'region'
    if comuna_col:
        rename_map[comuna_col] = 'comuna'
    pop.rename(columns=rename_map, inplace=True)
    pop['year'] = pd.to_numeric(pop['year'], errors='coerce').astype('Int64')
    pop = pop[pop['year'].isin(years)]
    pop['population'] = pd.to_numeric(pop['population'], errors='coerce')
    pop['sex'] = pop['sex'].apply(_standardize_sex)
    pop['age_group'] = pop['age'].apply(assign_age_group)
    pop = pop.dropna(subset=['year', 'sex', 'age_group', 'population'])
    pop = pop[pop['population'] > 0]
    if 'region' in pop.columns:
        pop['region'] = pop['region'].apply(normalize_region_to_standard)
    group_cols = [c for c in ['region', 'comuna', 'year', 'age_group', 'sex'] if c in pop.columns]
    pop_agg = pop.groupby(group_cols, as_index=False)['population'].sum()
    return pop_agg


def calculate_asr_by_sex(hosp, pop, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    hosp_agg = hosp.groupby(['year', 'age_group', 'sex'])['hospitalizations'].sum().reset_index()
    pop_agg = pop.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()
    merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    result = merged.groupby(['year', 'sex']).agg({
        'hospitalizations': 'sum',
        'population': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    result['crude_rate'] = ((result['hospitalizations'] / result['population']) * per).round(2)
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    result.drop(columns=['weighted_rate'], inplace=True)
    return result[['year', 'sex', 'hospitalizations', 'population', 'crude_rate', 'asr']]


def calculate_asr_sex_columns(hosp, pop, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    hosp_agg = hosp.groupby(['year', 'age_group', 'sex'])['hospitalizations'].sum().reset_index()
    pop_agg = pop.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()
    merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    by_sex = merged.groupby(['year', 'sex']).agg({
        'hospitalizations': 'sum',
        'population': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    by_sex['crude_rate'] = ((by_sex['hospitalizations'] / by_sex['population']) * per).round(2)
    by_sex['asr'] = (by_sex['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    hosp_total = hosp.groupby(['year', 'age_group'])['hospitalizations'].sum().reset_index()
    pop_total = pop.groupby(['year', 'age_group'])['population'].sum().reset_index()
    merged_total = hosp_total.merge(pop_total, on=['year', 'age_group'], how='left')
    merged_total = merged_total.dropna(subset=['population'])
    merged_total = merged_total[merged_total['population'] > 0]
    merged_total['age_specific_rate'] = (merged_total['hospitalizations'] / merged_total['population']) * per
    merged_total = merged_total.merge(who_weights, on='age_group', how='left')
    merged_total['weighted_rate'] = merged_total['age_specific_rate'] * merged_total['who_weight']
    total_agg = merged_total.groupby('year').agg({
        'hospitalizations': 'sum',
        'population': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    total_agg['crude_rate'] = ((total_agg['hospitalizations'] / total_agg['population']) * per).round(2)
    total_agg['asr'] = (total_agg['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    male = by_sex[by_sex['sex'] == 'Male'][['year', 'hospitalizations', 'population', 'crude_rate', 'asr']].copy()
    male.columns = ['year', 'hosp_male', 'pop_male', 'crude_rate_male', 'asr_male']
    female = by_sex[by_sex['sex'] == 'Female'][['year', 'hospitalizations', 'population', 'crude_rate', 'asr']].copy()
    female.columns = ['year', 'hosp_female', 'pop_female', 'crude_rate_female', 'asr_female']
    total = total_agg[['year', 'hospitalizations', 'population', 'crude_rate', 'asr']].copy()
    total.columns = ['year', 'hosp_total', 'pop_total', 'crude_rate_total', 'asr_total']
    result = male.merge(female, on='year', how='outer').merge(total, on='year', how='outer')
    result.sort_values('year', inplace=True)
    result.reset_index(drop=True, inplace=True)
    return result


def calculate_asr_by_icd(hosp, pop, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    hosp_agg = hosp.groupby(['year', 'age_group', 'sex', 'icd_code'])['hospitalizations'].sum().reset_index()
    pop_agg = pop.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()
    merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    by_sex = merged.groupby(['year', 'icd_code', 'sex']).agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    by_sex['asr'] = (by_sex['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    hosp_total = hosp.groupby(['year', 'age_group', 'icd_code'])['hospitalizations'].sum().reset_index()
    pop_total = pop.groupby(['year', 'age_group'])['population'].sum().reset_index()
    merged_total = hosp_total.merge(pop_total, on=['year', 'age_group'], how='left')
    merged_total = merged_total.dropna(subset=['population'])
    merged_total = merged_total[merged_total['population'] > 0]
    merged_total['age_specific_rate'] = (merged_total['hospitalizations'] / merged_total['population']) * per
    merged_total = merged_total.merge(who_weights, on='age_group', how='left')
    merged_total['weighted_rate'] = merged_total['age_specific_rate'] * merged_total['who_weight']
    total_agg = merged_total.groupby(['year', 'icd_code']).agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    total_agg['asr'] = (total_agg['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    male = by_sex[by_sex['sex'] == 'Male'][['year', 'icd_code', 'hospitalizations', 'asr']].copy()
    male.columns = ['year', 'icd_code', 'hosp_male', 'asr_male']
    female = by_sex[by_sex['sex'] == 'Female'][['year', 'icd_code', 'hospitalizations', 'asr']].copy()
    female.columns = ['year', 'icd_code', 'hosp_female', 'asr_female']
    total = total_agg[['year', 'icd_code', 'hospitalizations', 'asr']].copy()
    total.columns = ['year', 'icd_code', 'hosp_total', 'asr_total']
    result = male.merge(female, on=['year', 'icd_code'], how='outer')
    result = result.merge(total, on=['year', 'icd_code'], how='outer')
    result['description'] = result['icd_code'].map(ALL_ASD_CODES)
    cols = ['year', 'icd_code', 'description', 'hosp_male', 'hosp_female', 'hosp_total',
            'asr_male', 'asr_female', 'asr_total']
    result = result[cols]
    result.sort_values(['year', 'icd_code'], inplace=True)
    result.reset_index(drop=True, inplace=True)
    return result


def save_figure(fig, filename):
    filepath = os.path.join(figures_path, filename)
    fig.savefig(filepath, dpi=150, bbox_inches='tight', facecolor='white')
```

```{python}
#| label: load-data
#| include: false

hospitalizations = load_and_filter_f84_data(years=YEARS, chunksize=100000)
population_detail = load_population_data(years=YEARS)
population = population_detail.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()

if 'region' in population_detail.columns:
    population_regional = population_detail.groupby(['region', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
else:
    population_regional = None

hospitalizations.to_csv(os.path.join(output_path, 'hospitalizations_asd_f84.csv'), index=False)
population.to_csv(os.path.join(output_path, 'population_chile.csv'), index=False)
if population_regional is not None:
    population_regional.to_csv(os.path.join(output_path, 'population_chile_by_region.csv'), index=False)

asr_by_sex = calculate_asr_by_sex(hospitalizations, population)
asr_sex_cols = calculate_asr_sex_columns(hospitalizations, population)
asr_by_icd = calculate_asr_by_icd(hospitalizations, population)

asr_by_sex.to_csv(os.path.join(output_path, 'asr_by_sex_f84.csv'), index=False)
asr_sex_cols.to_csv(os.path.join(output_path, 'asr_sex_columns_f84.csv'), index=False)
asr_by_icd.to_csv(os.path.join(output_path, 'asr_by_icd_f84.csv'), index=False)
```

## Age-Standardized Rates Analysis

### Standardized Rates by Sex and Year

```{python}
#| label: tbl-asr-by-sex
#| tbl-cap: "Age-standardized hospitalization rates by sex (per 100,000)"
#| tbl-cap-location: bottom

asr_by_sex.style.format({
    'hospitalizations': '{:,.0f}',
    'population': '{:,.0f}',
    'crude_rate': '{:.2f}',
    'asr': '{:.2f}'
}).hide(axis="index")
```

```{python}
#| label: tbl-asr-sex-columns
#| tbl-cap: "Age-standardized rates with sex as columns (per 100,000)"
#| tbl-cap-location: bottom

asr_sex_cols.style.format({
    'hosp_male': '{:,.0f}',
    'hosp_female': '{:,.0f}',
    'hosp_total': '{:,.0f}',
    'pop_male': '{:,.0f}',
    'pop_female': '{:,.0f}',
    'pop_total': '{:,.0f}',
    'crude_rate_male': '{:.2f}',
    'crude_rate_female': '{:.2f}',
    'crude_rate_total': '{:.2f}',
    'asr_male': '{:.2f}',
    'asr_female': '{:.2f}',
    'asr_total': '{:.2f}'
}).hide(axis="index")
```

```{python}
#| label: fig-asr-sex-columns
#| fig-cap: "Age-standardized rates comparison (2019-2024)"
#| fig-width: 14
#| fig-height: 5

fig, axes = plt.subplots(1, 3, figsize=(14, 5))

ax1 = axes[0]
ax1.plot(asr_sex_cols['year'], asr_sex_cols['asr_male'], marker='o', linewidth=2, 
         markersize=8, label='Male', color='steelblue')
ax1.plot(asr_sex_cols['year'], asr_sex_cols['asr_female'], marker='s', linewidth=2, 
         markersize=8, label='Female', color='coral')
ax1.plot(asr_sex_cols['year'], asr_sex_cols['asr_total'], marker='^', linewidth=2, 
         markersize=8, label='Total', color='forestgreen', linestyle='--')
ax1.set_xlabel('Year')
ax1.set_ylabel('ASR (per 100,000)')
ax1.set_title('Age-Standardized Rate', fontweight='bold')
ax1.legend()
ax1.grid(True, alpha=0.3)
ax1.set_xticks(YEARS)

ax2 = axes[1]
ax2.plot(asr_sex_cols['year'], asr_sex_cols['crude_rate_male'], marker='o', linewidth=2, 
         markersize=8, label='Male', color='steelblue')
ax2.plot(asr_sex_cols['year'], asr_sex_cols['crude_rate_female'], marker='s', linewidth=2, 
         markersize=8, label='Female', color='coral')
ax2.plot(asr_sex_cols['year'], asr_sex_cols['crude_rate_total'], marker='^', linewidth=2, 
         markersize=8, label='Total', color='forestgreen', linestyle='--')
ax2.set_xlabel('Year')
ax2.set_ylabel('Crude Rate (per 100,000)')
ax2.set_title('Crude Rate', fontweight='bold')
ax2.legend()
ax2.grid(True, alpha=0.3)
ax2.set_xticks(YEARS)

ax3 = axes[2]
ax3.plot(asr_sex_cols['year'], asr_sex_cols['hosp_male'], marker='o', linewidth=2, 
         markersize=8, label='Male', color='steelblue')
ax3.plot(asr_sex_cols['year'], asr_sex_cols['hosp_female'], marker='s', linewidth=2, 
         markersize=8, label='Female', color='coral')
ax3.plot(asr_sex_cols['year'], asr_sex_cols['hosp_total'], marker='^', linewidth=2, 
         markersize=8, label='Total', color='forestgreen', linestyle='--')
ax3.set_xlabel('Year')
ax3.set_ylabel('Hospitalizations (N)')
ax3.set_title('Total Hospitalizations', fontweight='bold')
ax3.legend()
ax3.grid(True, alpha=0.3)
ax3.set_xticks(YEARS)

plt.tight_layout()
save_figure(fig, 'asr_sex_columns_f84.png')
plt.show()
```

\newpage

### Standardized Rates by ICD-10 Code

```{python}
#| label: tbl-asr-by-icd
#| tbl-cap: "Age-standardized rates by ICD-10 code - Latest year (per 100,000)"
#| tbl-cap-location: bottom

latest_year = asr_by_icd['year'].max()
asr_latest = asr_by_icd[asr_by_icd['year'] == latest_year].copy()

asr_latest.style.format({
    'hosp_male': '{:,.0f}',
    'hosp_female': '{:,.0f}',
    'hosp_total': '{:,.0f}',
    'asr_male': '{:.2f}',
    'asr_female': '{:.2f}',
    'asr_total': '{:.2f}'
}).hide(axis="index")
```

```{python}
#| label: fig-asr-by-icd-f84
#| fig-cap: "ASR trends for ASD codes (F84.x)"
#| fig-width: 16
#| fig-height: 10

f84_codes = [c for c in F84_CODES_LIST if c in asr_by_icd['icd_code'].unique()]
asr_f84_codes = asr_by_icd[asr_by_icd['icd_code'].isin(f84_codes)]

n_codes = len(f84_codes)
ncols = 3
nrows = max(1, (n_codes + ncols - 1) // ncols)

fig, axes = plt.subplots(nrows, ncols, figsize=(16, 4*nrows))
if n_codes > 1:
    axes = axes.flatten()
else:
    axes = [axes]

for idx, code in enumerate(f84_codes):
    ax = axes[idx]
    df_code = asr_f84_codes[asr_f84_codes['icd_code'] == code]
    if not df_code.empty:
        ax.plot(df_code['year'], df_code['asr_male'], marker='o', linewidth=2, 
                markersize=6, label='Male', color='steelblue')
        ax.plot(df_code['year'], df_code['asr_female'], marker='s', linewidth=2, 
                markersize=6, label='Female', color='coral')
        ax.plot(df_code['year'], df_code['asr_total'], marker='^', linewidth=2, 
                markersize=6, label='Total', color='forestgreen', linestyle='--')
    desc = ALL_ASD_CODES.get(code, code)[:35]
    ax.set_title(f'{code}: {desc}', fontsize=10, fontweight='bold')
    ax.set_xlabel('Year')
    ax.set_ylabel('ASR')
    ax.legend(fontsize=8)
    ax.grid(True, alpha=0.3)
    ax.set_xticks(YEARS)
    ax.tick_params(axis='x', rotation=45)

for idx in range(len(f84_codes), len(axes)):
    axes[idx].set_visible(False)

plt.suptitle('Age-Standardized Rates - ASD codes (F84.x)', fontsize=14, fontweight='bold')
plt.tight_layout()
save_figure(fig, 'asr_f84_codes.png')
plt.show()
```

```{python}
#| label: fig-heatmap-asr
#| fig-cap: "Heatmap of ASR by ICD code and year"
#| fig-width: 12
#| fig-height: 8

heatmap_data = asr_by_icd.pivot_table(
    index='icd_code',
    columns='year',
    values='asr_total',
    aggfunc='first'
)

fig, ax = plt.subplots(figsize=(12, 8))
sns.heatmap(heatmap_data, annot=True, fmt='.2f', cmap='YlOrRd', 
            cbar_kws={'label': 'ASR (per 100,000)'}, ax=ax)
ax.set_title('Age-Standardized Rates Heatmap - F84 Codes', fontweight='bold', fontsize=14)
ax.set_xlabel('Year')
ax.set_ylabel('ICD-10 Code')

plt.tight_layout()
save_figure(fig, 'asr_heatmap_f84.png')
plt.show()
```

\newpage

## Sex Ratio Analysis

```{python}
#| label: sex-ratio-calculation
#| include: false

sex_ratio = asr_sex_cols.copy()
sex_ratio['sex_ratio'] = sex_ratio['hosp_male'] / sex_ratio['hosp_female'].replace(0, np.nan)
sex_ratio['asr_ratio'] = sex_ratio['asr_male'] / sex_ratio['asr_female'].replace(0, np.nan)

sex_by_icd = asr_by_icd.groupby('icd_code').agg({
    'hosp_male': 'sum',
    'hosp_female': 'sum',
    'asr_male': 'mean',
    'asr_female': 'mean'
}).reset_index()
sex_by_icd['sex_ratio'] = sex_by_icd['hosp_male'] / sex_by_icd['hosp_female'].replace(0, np.nan)
sex_by_icd['asr_ratio'] = sex_by_icd['asr_male'] / sex_by_icd['asr_female'].replace(0, np.nan)
sex_by_icd['description'] = sex_by_icd['icd_code'].map(ALL_ASD_CODES)
```

```{python}
#| label: tbl-sex-ratio
#| tbl-cap: "Male to Female Ratio by Year"
#| tbl-cap-location: bottom

sex_ratio_display = sex_ratio[['year', 'hosp_male', 'hosp_female', 'sex_ratio', 'asr_male', 'asr_female', 'asr_ratio']].copy()
sex_ratio_display.columns = ['Year', 'Male Hosp.', 'Female Hosp.', 'M:F Ratio (N)', 'ASR Male', 'ASR Female', 'M:F Ratio (ASR)']

sex_ratio_display.style.format({
    'Male Hosp.': '{:,.0f}',
    'Female Hosp.': '{:,.0f}',
    'M:F Ratio (N)': '{:.2f}',
    'ASR Male': '{:.2f}',
    'ASR Female': '{:.2f}',
    'M:F Ratio (ASR)': '{:.2f}'
}).hide(axis="index")
```

```{python}
#| label: fig-sex-ratio
#| fig-cap: "Male to Female Ratio in ASD Hospitalizations"
#| fig-width: 14
#| fig-height: 6

fig, axes = plt.subplots(1, 2, figsize=(14, 6))

ax1 = axes[0]
ax1.bar(sex_ratio['year'], sex_ratio['sex_ratio'], color='purple', alpha=0.7, label='Hospitalizations')
ax1.plot(sex_ratio['year'], sex_ratio['asr_ratio'], marker='o', linewidth=2, color='darkred', label='ASR')
ax1.axhline(y=1, color='gray', linestyle='--', linewidth=2, label='Equal ratio')
ax1.set_xlabel('Year')
ax1.set_ylabel('Male:Female Ratio')
ax1.set_title('Sex Ratio Over Time', fontweight='bold')
ax1.legend()
ax1.grid(True, alpha=0.3, axis='y')
ax1.set_xticks(YEARS)

ax2 = axes[1]
sex_by_icd_sorted = sex_by_icd.sort_values('sex_ratio', ascending=True)
colors = ['coral' if r < 1 else 'steelblue' for r in sex_by_icd_sorted['sex_ratio']]
labels = [f"{row['icd_code']}: {row['description'][:25]}" for _, row in sex_by_icd_sorted.iterrows()]
ax2.barh(labels, sex_by_icd_sorted['sex_ratio'], color=colors)
ax2.axvline(x=1, color='gray', linestyle='--', linewidth=2)
ax2.set_xlabel('Male:Female Ratio')
ax2.set_title('Sex Ratio by Diagnosis (F84.x)', fontweight='bold')
ax2.grid(True, alpha=0.3, axis='x')

plt.suptitle('Sex Differences in Autism Spectrum Disorders', fontsize=14, fontweight='bold', y=1.02)
plt.tight_layout()
save_figure(fig, 'sex_ratio_f84.png')
plt.show()
```

```{python}
#| label: tbl-sex-ratio-by-icd
#| tbl-cap: "Sex Ratio Summary by F84 Subcode"
#| tbl-cap-location: bottom

sex_summary = sex_by_icd[['icd_code', 'description', 'hosp_male', 'hosp_female', 'sex_ratio', 'asr_ratio']].copy()
sex_summary.columns = ['ICD Code', 'Description', 'Male Hosp.', 'Female Hosp.', 'M:F Ratio (N)', 'M:F Ratio (ASR)']
sex_summary = sex_summary.sort_values('M:F Ratio (N)', ascending=False)

sex_summary.style.format({
    'Male Hosp.': '{:,.0f}',
    'Female Hosp.': '{:,.0f}',
    'M:F Ratio (N)': '{:.2f}',
    'M:F Ratio (ASR)': '{:.2f}'
}, na_rep='-').hide(axis="index")
```

\newpage

## Age Distribution Analysis

```{python}
#| label: fig-age-distribution
#| fig-cap: "Age Distribution of ASD Hospitalizations"
#| fig-width: 16
#| fig-height: 10

fig, axes = plt.subplots(2, 2, figsize=(16, 10))

age_dist = hospitalizations.groupby('age_group')['hospitalizations'].sum()
age_dist = age_dist.reindex([a for a in AGE_ORDER if a in age_dist.index])

ax1 = axes[0, 0]
ax1.bar(age_dist.index, age_dist.values, color='teal', alpha=0.7)
ax1.set_xlabel('Age Group')
ax1.set_ylabel('Hospitalizations')
ax1.set_title('Overall Age Distribution', fontweight='bold')
ax1.tick_params(axis='x', rotation=45)
ax1.grid(True, alpha=0.3, axis='y')

ax2 = axes[0, 1]
age_sex = hospitalizations.groupby(['age_group', 'sex'])['hospitalizations'].sum().unstack(fill_value=0)
age_sex = age_sex.reindex([a for a in AGE_ORDER if a in age_sex.index])
age_sex.plot(kind='bar', ax=ax2, color=['steelblue', 'coral'], width=0.8)
ax2.set_xlabel('Age Group')
ax2.set_ylabel('Hospitalizations')
ax2.set_title('Age Distribution by Sex', fontweight='bold')
ax2.tick_params(axis='x', rotation=45)
ax2.legend(title='Sex')
ax2.grid(True, alpha=0.3, axis='y')

ax3 = axes[1, 0]
age_icd = hospitalizations.groupby(['age_group', 'icd_code'])['hospitalizations'].sum().unstack(fill_value=0)
age_icd = age_icd.reindex([a for a in AGE_ORDER if a in age_icd.index])
age_icd.plot(kind='bar', ax=ax3, colormap='tab10', width=0.8, stacked=True)
ax3.set_xlabel('Age Group')
ax3.set_ylabel('Hospitalizations')
ax3.set_title('Age Distribution by F84 Subcode', fontweight='bold')
ax3.tick_params(axis='x', rotation=45)
ax3.legend(title='ICD Code', bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=8)
ax3.grid(True, alpha=0.3, axis='y')

ax4 = axes[1, 1]
pediatric_groups = ['0-4', '5-9', '10-14', '15-19']
pediatric_data = hospitalizations[hospitalizations['age_group'].isin(pediatric_groups)]
ped_by_sex = pediatric_data.groupby('sex')['hospitalizations'].sum()
colors = ['steelblue', 'coral']
wedges, texts, autotexts = ax4.pie(ped_by_sex.values, labels=ped_by_sex.index, 
                                    autopct='%1.1f%%', colors=colors, startangle=90)
ax4.set_title('Pediatric Population (0-19 years) by Sex', fontweight='bold')

plt.suptitle('Age Patterns in Autism Spectrum Disorders', fontsize=14, fontweight='bold', y=1.02)
plt.tight_layout()
save_figure(fig, 'age_distribution_f84.png')
plt.show()
```

```{python}
#| label: tbl-age-summary
#| tbl-cap: "Hospitalization Summary by Age Group"
#| tbl-cap-location: bottom

age_summary = hospitalizations.groupby('age_group').agg({
    'hospitalizations': 'sum'
}).reset_index()

total_hosp = age_summary['hospitalizations'].sum()
age_summary['percentage'] = (age_summary['hospitalizations'] / total_hosp * 100).round(2)
age_summary['age_order'] = age_summary['age_group'].apply(lambda x: AGE_ORDER.index(x) if x in AGE_ORDER else 99)
age_summary = age_summary.sort_values('age_order').drop(columns='age_order')
age_summary.columns = ['Age Group', 'Hospitalizations', 'Percentage (%)']

age_summary.style.format({
    'Hospitalizations': '{:,.0f}',
    'Percentage (%)': '{:.2f}'
}).hide(axis="index")
```

```{python}
#| label: tbl-age-sex-cross
#| tbl-cap: "Hospitalizations by Age Group and Sex"
#| tbl-cap-location: bottom

age_sex_table = hospitalizations.groupby(['age_group', 'sex'])['hospitalizations'].sum().unstack(fill_value=0)
age_sex_table = age_sex_table.reindex([a for a in AGE_ORDER if a in age_sex_table.index])
age_sex_table['Total'] = age_sex_table.sum(axis=1)
age_sex_table['M:F Ratio'] = (age_sex_table['Male'] / age_sex_table['Female'].replace(0, np.nan)).round(2)

age_sex_table.style.format({
    'Male': '{:,.0f}',
    'Female': '{:,.0f}',
    'Total': '{:,.0f}',
    'M:F Ratio': '{:.2f}'
}, na_rep='-')
```

\newpage

## Regional Analysis

```{python}
#| label: setup-regional
#| include: false

SERVICIO_TO_REGION = {
    'ARICA': 'Arica y Parinacota',
    'IQUIQUE': 'Tarapacá',
    'ANTOFAGASTA': 'Antofagasta',
    'ATACAMA': 'Atacama',
    'COQUIMBO': 'Coquimbo',
    'VALPARAISO': 'Valparaíso',
    'VIÑA DEL MAR': 'Valparaíso',
    'ACONCAGUA': 'Valparaíso',
    'OHIGGINS': "O'Higgins",
    'MAULE': 'Maule',
    'ÑUBLE': 'Ñuble',
    'CONCEPCION': 'Biobío',
    'TALCAHUANO': 'Biobío',
    'BIOBIO': 'Biobío',
    'ARAUCANIA NORTE': 'La Araucanía',
    'ARAUCANIA SUR': 'La Araucanía',
    'VALDIVIA': 'Los Ríos',
    'OSORNO': 'Los Lagos',
    'RELONCAVI': 'Los Lagos',
    'CHILOE': 'Los Lagos',
    'AYSEN': 'Aysén',
    'MAGALLANES': 'Magallanes',
    'METROPOLITANO NORTE': 'Metropolitana',
    'METROPOLITANO OCCIDENTE': 'Metropolitana',
    'METROPOLITANO CENTRAL': 'Metropolitana',
    'METROPOLITANO ORIENTE': 'Metropolitana',
    'METROPOLITANO SUR': 'Metropolitana',
    'METROPOLITANO SUR ORIENTE': 'Metropolitana'
}
```

```{python}
#| label: load-regional-data
#| include: false

def load_regional_f84_data(years=YEARS, chunksize=100000):
    all_records = []
    for year in years:
        pattern = f"GRD_PUBLICO_*{year}*.csv"
        files = glob.glob(os.path.join(data_path, pattern))
        if not files:
            continue
        for chunk in pd.read_csv(files[0], delimiter='|', dtype=str, 
                                  low_memory=False, chunksize=chunksize):
            diag_cols = [col for col in chunk.columns if col.startswith('DIAGNOSTICO')]
            if not diag_cols:
                continue
            for _, row in chunk.iterrows():
                codes_found = get_f84_codes_from_row(row, diag_cols)
                if not codes_found:
                    continue
                age = calculate_age(row.get('FECHA_NACIMIENTO'), row.get('FECHA_INGRESO'))
                age_group = assign_age_group(age)
                sex_val = str(row.get('SEXO', '')).strip().upper()
                sex = 'Male' if sex_val in ['1', 'HOMBRE'] else ('Female' if sex_val in ['2', 'MUJER'] else None)
                servicio = str(row.get('SERVICIO_SALUD', '')).strip().upper()
                comuna = str(row.get('COMUNA', '')).strip()
                region = None
                for key, val in SERVICIO_TO_REGION.items():
                    if key in servicio:
                        region = val
                        break
                for code in codes_found:
                    all_records.append({
                        'year': year,
                        'age': age,
                        'age_group': age_group,
                        'sex': sex,
                        'icd_code': code,
                        'servicio_salud': servicio,
                        'region': region,
                        'comuna': comuna
                    })
    if not all_records:
        return pd.DataFrame()
    return pd.DataFrame(all_records)

regional_data = load_regional_f84_data()
regional_data.to_csv(os.path.join(output_path, 'hospitalizations_regional_f84.csv'), index=False)
regional_data = regional_data[regional_data['region'].notna()].copy()
```

```{python}
#| label: regional-asr-calculation
#| include: false

REGION_NORM_MAP = {
    'METROPOLITANA': 'METROPOLITANA',
    'METROPOLITANA DE SANTIAGO': 'METROPOLITANA',
    "O'HIGGINS": 'OHIGGINS',
    "OHIGGINS": 'OHIGGINS',
    "LIBERTADOR GENERAL BERNARDO O'HIGGINS": 'OHIGGINS',
    "LIBERTADOR GENERAL BERNARDO OHIGGINS": 'OHIGGINS',
    'AYSEN': 'AYSEN',
    'AYSEN DEL GENERAL CARLOS IBANEZ DEL CAMPO': 'AYSEN',
    'MAGALLANES': 'MAGALLANES',
    'MAGALLANES Y DE LA ANTARTICA CHILENA': 'MAGALLANES',
    'MAGALLANES Y ANTARTICA CHILENA': 'MAGALLANES',
    'ARICA Y PARINACOTA': 'ARICA Y PARINACOTA',
    'TARAPACA': 'TARAPACA',
    'ANTOFAGASTA': 'ANTOFAGASTA',
    'ATACAMA': 'ATACAMA',
    'COQUIMBO': 'COQUIMBO',
    'VALPARAISO': 'VALPARAISO',
    'MAULE': 'MAULE',
    'NUBLE': 'NUBLE',
    'BIOBIO': 'BIOBIO',
    'LA ARAUCANIA': 'LA ARAUCANIA',
    'LOS RIOS': 'LOS RIOS',
    'LOS LAGOS': 'LOS LAGOS'
}

def _normalize_region_basic(x):
    if pd.isna(x):
        return None
    s = str(x).upper().strip()
    replacements = {'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U', 'Ñ': 'N'}
    for old, new in replacements.items():
        s = s.replace(old, new)
    s = s.replace('\u2019', "'")
    return REGION_NORM_MAP.get(s, s)


def calculate_regional_asr(regional_df, population_df, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    hosp_agg = regional_df.groupby(['region', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')
    if population_df is not None and 'region' in population_df.columns:
        pop_agg = population_df.groupby(['region', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
        hosp_agg['region_norm'] = hosp_agg['region'].apply(_normalize_region_basic)
        pop_agg['region_norm'] = pop_agg['region'].apply(_normalize_region_basic)
        merged = hosp_agg.merge(
            pop_agg[['region_norm', 'year', 'age_group', 'sex', 'population']],
            on=['region_norm', 'year', 'age_group', 'sex'],
            how='left'
        )
    else:
        pop_agg = population_df.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()
        merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    result = merged.groupby(['region', 'year']).agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    return result[['region', 'year', 'hospitalizations', 'asr']]


def calculate_regional_asr_by_sex(regional_df, population_df, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    hosp_agg = regional_df.groupby(['region', 'sex', 'year', 'age_group']).size().reset_index(name='hospitalizations')
    if population_df is not None and 'region' in population_df.columns:
        pop_agg = population_df.groupby(['region', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
        hosp_agg['region_norm'] = hosp_agg['region'].apply(_normalize_region_basic)
        pop_agg['region_norm'] = pop_agg['region'].apply(_normalize_region_basic)
        merged = hosp_agg.merge(
            pop_agg[['region_norm', 'year', 'age_group', 'sex', 'population']],
            on=['region_norm', 'year', 'age_group', 'sex'],
            how='left'
        )
    else:
        pop_agg = population_df.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()
        merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    result = merged.groupby(['region', 'sex']).agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    return result[['region', 'sex', 'hospitalizations', 'asr']]


regional_asr = calculate_regional_asr(regional_data, population_regional if population_regional is not None else population)
regional_asr_sex = calculate_regional_asr_by_sex(regional_data, population_regional if population_regional is not None else population)

total_by_region = regional_data.groupby('region').size().reset_index(name='total_hospitalizations')
total_by_region = total_by_region.sort_values('total_hospitalizations', ascending=False)

mean_asr_region = regional_asr.groupby('region')['asr'].mean().reset_index()
mean_asr_region.columns = ['region', 'mean_asr']
mean_asr_region = mean_asr_region.sort_values('mean_asr', ascending=False)

regional_sex_ratio = regional_asr_sex.pivot(index='region', columns='sex', values='hospitalizations').reset_index()
regional_sex_ratio['sex_ratio'] = regional_sex_ratio['Male'] / regional_sex_ratio['Female'].replace(0, np.nan)
```

### Age-Standardized Rates by Region

```{python}
#| label: tbl-regional-asr
#| tbl-cap: "Age-standardized hospitalization rates by region (per 100,000)"
#| tbl-cap-location: bottom

regional_asr_pivot = regional_asr.pivot_table(
    index='region',
    columns='year',
    values='asr',
    aggfunc='first'
).reset_index()

regional_asr_pivot['Mean ASR'] = regional_asr_pivot[[c for c in regional_asr_pivot.columns if c != 'region']].mean(axis=1).round(2)
regional_asr_pivot = regional_asr_pivot.sort_values('Mean ASR', ascending=False)

year_cols = [c for c in regional_asr_pivot.columns if isinstance(c, (int, float)) and c != 'Mean ASR']
format_dict = {col: '{:.2f}' for col in year_cols + ['Mean ASR']}

regional_asr_pivot.style.format(format_dict, na_rep='-').background_gradient(
    cmap='YlOrRd', subset=['Mean ASR']
).hide(axis="index")
```

```{python}
#| label: fig-regional-asr-trend
#| fig-cap: "Age-standardized rates trend by region (2019-2024)"
#| fig-width: 16
#| fig-height: 8

fig, axes = plt.subplots(1, 2, figsize=(16, 8))

all_regions = mean_asr_region['region'].tolist()

ax1 = axes[0]
for region in all_regions:
    df_reg = regional_asr[regional_asr['region'] == region]
    ax1.plot(df_reg['year'], df_reg['asr'], marker='o', linewidth=2, markersize=5, label=region)

ax1.set_xlabel('Year')
ax1.set_ylabel('ASR (per 100,000)')
ax1.set_title('ASR Trend - All Regions', fontweight='bold')
ax1.legend(bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=8)
ax1.grid(True, alpha=0.3)
ax1.set_xticks(YEARS)

ax2 = axes[1]
data_sorted = mean_asr_region.sort_values('mean_asr', ascending=True)
colors = plt.cm.YlOrRd(data_sorted['mean_asr'] / data_sorted['mean_asr'].max())
ax2.barh(data_sorted['region'], data_sorted['mean_asr'], color=colors)
ax2.set_xlabel('Mean ASR (per 100,000)')
ax2.set_title('Mean ASR by Region (2019-2024)', fontweight='bold')
ax2.grid(True, alpha=0.3, axis='x')

plt.tight_layout()
save_figure(fig, 'regional_asr_trends_f84.png')
plt.show()
```

### Regional Sex Ratio Analysis

```{python}
#| label: tbl-regional-sex-ratio
#| tbl-cap: "Sex Ratio by Region"
#| tbl-cap-location: bottom

regional_sex_display = regional_sex_ratio.merge(mean_asr_region, on='region')
regional_sex_display = regional_sex_display[['region', 'Male', 'Female', 'sex_ratio', 'mean_asr']]
regional_sex_display.columns = ['Region', 'Male Hosp.', 'Female Hosp.', 'M:F Ratio', 'Mean ASR']
regional_sex_display = regional_sex_display.sort_values('M:F Ratio', ascending=False)

regional_sex_display.style.format({
    'Male Hosp.': '{:,.0f}',
    'Female Hosp.': '{:,.0f}',
    'M:F Ratio': '{:.2f}',
    'Mean ASR': '{:.2f}'
}, na_rep='-').hide(axis="index")
```

```{python}
#| label: fig-regional-sex-ratio
#| fig-cap: "Regional Sex Ratio Comparison"
#| fig-width: 14
#| fig-height: 8

fig, axes = plt.subplots(1, 2, figsize=(14, 8))

ax1 = axes[0]
reg_sorted = regional_sex_ratio.sort_values('sex_ratio', ascending=True)
colors = ['coral' if r < 2 else ('steelblue' if r < 4 else 'darkblue') for r in reg_sorted['sex_ratio']]
ax1.barh(reg_sorted['region'], reg_sorted['sex_ratio'], color=colors)
ax1.axvline(x=1, color='gray', linestyle='--', linewidth=2, label='Equal ratio')
ax1.axvline(x=4, color='red', linestyle=':', linewidth=2, label='Literature avg (4:1)')
ax1.set_xlabel('Male:Female Ratio')
ax1.set_title('Sex Ratio by Region', fontweight='bold')
ax1.legend()
ax1.grid(True, alpha=0.3, axis='x')

ax2 = axes[1]
regional_sex_pivot = regional_asr_sex.pivot(index='region', columns='sex', values='asr').reset_index()
regional_sex_pivot = regional_sex_pivot.sort_values('Male', ascending=False)
x = np.arange(len(regional_sex_pivot))
width = 0.35
ax2.barh(x - width/2, regional_sex_pivot['Male'], width, label='Male', color='steelblue')
ax2.barh(x + width/2, regional_sex_pivot['Female'], width, label='Female', color='coral')
ax2.set_yticks(x)
ax2.set_yticklabels(regional_sex_pivot['region'])
ax2.set_xlabel('ASR (per 100,000)')
ax2.set_title('ASR by Sex and Region', fontweight='bold')
ax2.legend()
ax2.grid(True, alpha=0.3, axis='x')

plt.tight_layout()
save_figure(fig, 'regional_sex_ratio_f84.png')
plt.show()
```

### Regional Age Distribution

```{python}
#| label: fig-regional-age-dist
#| fig-cap: "Age Distribution by Region"
#| fig-width: 16
#| fig-height: 10

regional_age = regional_data.groupby(['region', 'age_group']).size().reset_index(name='hospitalizations')
regional_age_pivot = regional_age.pivot(index='region', columns='age_group', values='hospitalizations').fillna(0)
regional_age_pivot = regional_age_pivot[[c for c in AGE_ORDER if c in regional_age_pivot.columns]]

fig, axes = plt.subplots(1, 2, figsize=(16, 10))

ax1 = axes[0]
sns.heatmap(regional_age_pivot, annot=True, fmt='.0f', cmap='YlOrRd', ax=ax1,
            cbar_kws={'label': 'Hospitalizations'})
ax1.set_title('Hospitalizations by Region and Age Group', fontweight='bold')
ax1.set_xlabel('Age Group')
ax1.set_ylabel('Region')

ax2 = axes[1]
pediatric = ['0-4', '5-9', '10-14', '15-19']
adult = ['20-24', '25-29', '30-34', '35-39', '40-44', '45-49', '50-54', '55-59', '60-64', '65-69', '70-74', '75-79', '80+']
regional_age_pivot['Pediatric'] = regional_age_pivot[[c for c in pediatric if c in regional_age_pivot.columns]].sum(axis=1)
regional_age_pivot['Adult'] = regional_age_pivot[[c for c in adult if c in regional_age_pivot.columns]].sum(axis=1)
regional_age_pivot['Pediatric_pct'] = (regional_age_pivot['Pediatric'] / (regional_age_pivot['Pediatric'] + regional_age_pivot['Adult']) * 100).round(1)

ped_sorted = regional_age_pivot.sort_values('Pediatric_pct', ascending=True)
ax2.barh(ped_sorted.index, ped_sorted['Pediatric_pct'], color='teal', alpha=0.7)
ax2.axvline(x=50, color='gray', linestyle='--', linewidth=2)
ax2.set_xlabel('Pediatric Percentage (%)')
ax2.set_title('Proportion of Pediatric Cases (0-19 years) by Region', fontweight='bold')
ax2.grid(True, alpha=0.3, axis='x')

plt.tight_layout()
save_figure(fig, 'regional_age_distribution_f84.png')
plt.show()
```

\newpage

## National Comunal Analysis

```{python}
#| label: filter-national-comuna-data
#| include: false

all_comunas_pop = population_detail['comuna'].unique().tolist() if 'comuna' in population_detail.columns else []
all_comunas_norm = set(normalize_comuna(c) for c in all_comunas_pop if pd.notna(c))

regional_data['comuna_norm'] = regional_data['comuna'].apply(normalize_comuna)
national_comuna_data = regional_data[regional_data['comuna_norm'].isin(all_comunas_norm)].copy()

pop_nacional = population_detail.copy()
pop_nacional['comuna_norm'] = pop_nacional['comuna'].apply(normalize_comuna)

total_by_comuna_all = national_comuna_data.groupby('comuna').size().reset_index(name='total_hospitalizations')
total_by_comuna_all = total_by_comuna_all.sort_values('total_hospitalizations', ascending=False)


def calculate_comuna_asr_national(df, pop_df, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    df = df.copy()
    df['comuna_norm'] = df['comuna'].apply(normalize_comuna)
    hosp_agg = df.groupby(['comuna_norm', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')
    pop_agg = pop_df.groupby(['comuna_norm', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
    merged = hosp_agg.merge(pop_agg, on=['comuna_norm', 'year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    result = merged.groupby('comuna_norm').agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    comuna_map = df.drop_duplicates('comuna_norm')[['comuna', 'comuna_norm']]
    result = result.merge(comuna_map, on='comuna_norm', how='left')
    return result[['comuna', 'comuna_norm', 'hospitalizations', 'asr']]


def calculate_comuna_icd_asr_national(df, pop_df, icd_code, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    df_filtered = df[df['icd_code'] == icd_code].copy()
    if len(df_filtered) == 0:
        return pd.DataFrame(columns=['comuna', 'comuna_norm', 'hospitalizations', 'asr'])
    df_filtered['comuna_norm'] = df_filtered['comuna'].apply(normalize_comuna)
    hosp_agg = df_filtered.groupby(['comuna_norm', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')
    pop_agg = pop_df.groupby(['comuna_norm', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
    merged = hosp_agg.merge(pop_agg, on=['comuna_norm', 'year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    if len(merged) == 0:
        return pd.DataFrame(columns=['comuna', 'comuna_norm', 'hospitalizations', 'asr'])
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    result = merged.groupby('comuna_norm').agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    comuna_map = df_filtered.drop_duplicates('comuna_norm')[['comuna', 'comuna_norm']]
    result = result.merge(comuna_map, on='comuna_norm', how='left')
    return result[['comuna', 'comuna_norm', 'hospitalizations', 'asr']]


comuna_asr_all = calculate_comuna_asr_national(national_comuna_data, pop_nacional)

icd_codes_present = national_comuna_data['icd_code'].unique().tolist()
comuna_asr_by_icd = {}
for icd in icd_codes_present:
    comuna_asr_by_icd[icd] = calculate_comuna_icd_asr_national(national_comuna_data, pop_nacional, icd)

comuna_asr_all.to_csv(os.path.join(output_path, 'comuna_asr_national_f84.csv'), index=False)

comuna_asr = comuna_asr_all[~comuna_asr_all['comuna'].apply(is_excluded_comuna)].copy()
total_by_comuna = total_by_comuna_all[~total_by_comuna_all['comuna'].apply(is_excluded_comuna)].copy()

mean_asr_comuna = comuna_asr.sort_values('asr', ascending=False)
```

### Hospitalizations by Comuna - Chile Continental

```{python}
#| label: tbl-national-summary
#| tbl-cap: "Top 50 comunas by ASR - Chile Continental"
#| tbl-cap-location: bottom

national_summary = total_by_comuna.merge(
    mean_asr_comuna[['comuna', 'asr']], 
    on='comuna', 
    how='left'
)
national_summary.columns = ['Comuna', 'Total Hosp.', 'ASR']
national_summary = national_summary.sort_values('ASR', ascending=False)

national_summary.head(50).style.format({
    'Total Hosp.': '{:,.0f}',
    'ASR': '{:.2f}'
}, na_rep='-').hide(axis="index")
```

```{python}
#| label: fig-national-bars
#| fig-cap: "Top 30 comunas by hospitalizations - Chile Continental"
#| fig-width: 16
#| fig-height: 10

fig, axes = plt.subplots(1, 2, figsize=(16, 10))

top30_hosp = total_by_comuna.head(30)

ax1 = axes[0]
data_sorted = top30_hosp.sort_values('total_hospitalizations', ascending=True)
colors = plt.cm.Blues(np.linspace(0.3, 0.9, len(data_sorted)))
ax1.barh(data_sorted['comuna'], data_sorted['total_hospitalizations'], color=colors)
ax1.set_xlabel('Total Hospitalizations')
ax1.set_title('Top 30 Comunas by Hospitalizations', fontweight='bold')
ax1.grid(True, alpha=0.3, axis='x')

top30_asr = mean_asr_comuna.head(30)

ax2 = axes[1]
data_sorted_asr = top30_asr.sort_values('asr', ascending=True)
colors_asr = plt.cm.YlOrRd(data_sorted_asr['asr'] / data_sorted_asr['asr'].max())
ax2.barh(data_sorted_asr['comuna'], data_sorted_asr['asr'], color=colors_asr)
ax2.set_xlabel('ASR (per 100,000)')
ax2.set_title('Top 30 Comunas by ASR', fontweight='bold')
ax2.grid(True, alpha=0.3, axis='x')

plt.suptitle('National Comunal Analysis - Chile Continental (2019-2024)', fontsize=14, fontweight='bold', y=1.02)
plt.tight_layout()
save_figure(fig, 'national_comunas_f84.png')
plt.show()
```

```{python}
#| label: tbl-national-stats
#| tbl-cap: "National Comunal Analysis Summary Statistics"
#| tbl-cap-location: bottom

main_icd_national = national_comuna_data['icd_code'].value_counts().idxmax() if len(national_comuna_data) > 0 else 'N/A'
main_icd_desc = ALL_ASD_CODES.get(main_icd_national, 'N/A')

excluded_count = len(total_by_comuna_all) - len(total_by_comuna)

national_stats = pd.DataFrame({
    'Metric': [
        'Total Hospitalizations',
        'Comunas Analyzed (Continental)',
        'Comunas Excluded (Non-Continental)',
        'Years Covered',
        'Mean Hospitalizations/Year',
        'Comuna with Most Cases',
        'Most Common Diagnosis',
        'F84 Codes Present'
    ],
    'Value': [
        f"{len(national_comuna_data):,.0f}",
        len(total_by_comuna),
        excluded_count,
        f"{national_comuna_data['year'].nunique()} ({national_comuna_data['year'].min()}-{national_comuna_data['year'].max()})",
        f"{len(national_comuna_data) / national_comuna_data['year'].nunique():,.0f}",
        total_by_comuna.iloc[0]['comuna'] if len(total_by_comuna) > 0 else 'N/A',
        f"{main_icd_national} ({main_icd_desc})",
        national_comuna_data['icd_code'].nunique()
    ]
})

national_stats.style.hide(axis="index")
```

\newpage

## Spatial Analysis - Chile Continental

```{python}
#| label: load-spatial-libs
#| include: false

from libpysal.weights import Queen
from esda.moran import Moran, Moran_Local
from splot.esda import moran_scatterplot
from matplotlib.patches import Patch

shp_candidates = [
    os.path.join(data_path, 'comunas.shp'),
    os.path.join(os.getcwd(), 'comunas.shp'),
    os.path.join(os.getcwd(), 'data', 'comunas.shp'),
    os.path.join(data_path, 'comunas_chile.shp'),
    os.path.join(data_path, 'division_comunal.shp')
]

shp_path = None
for candidate in shp_candidates:
    if os.path.exists(candidate):
        shp_path = candidate
        break

has_spatial_data = False
gdf_chile = None
gdf_continental = None
gdf_f84 = None
pesos = None
has_f84_data = False
COMUNA_COL = None
REGION_CODE_COL = None

if shp_path:
    gdf_chile = gpd.read_file(shp_path)
    
    def normalize_comuna_spatial(x):
        if pd.isna(x):
            return None
        s = str(x).upper().strip()
        s = s.encode('latin-1', errors='ignore').decode('latin-1', errors='ignore')
        replacements = {
            'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U', 'Ñ': 'N',
            'Ã\x81': 'A', 'Ã\x89': 'E', 'Ã\x8d': 'I', 'Ã\x93': 'O', 'Ã\x9a': 'U',
            'Ã\x91': 'N', 'Ã±': 'N'
        }
        for old, new in replacements.items():
            s = s.replace(old, new)
        s = ''.join(c for c in s if c.isalnum() or c == ' ')
        return s.strip()
    
    for col in ['Comuna', 'COMUNA', 'NOM_COMUNA', 'nom_comuna', 'NAME']:
        if col in gdf_chile.columns:
            COMUNA_COL = col
            break
    if COMUNA_COL is None:
        COMUNA_COL = gdf_chile.columns[0]
    
    for col in ['codregion', 'CODREGION', 'COD_REGION', 'Region', 'REGION']:
        if col in gdf_chile.columns:
            REGION_CODE_COL = col
            break
    
    gdf_chile["comuna_norm"] = gdf_chile[COMUNA_COL].apply(normalize_comuna_spatial)
    
    if REGION_CODE_COL:
        gdf_chile[REGION_CODE_COL] = pd.to_numeric(gdf_chile[REGION_CODE_COL], errors='coerce')
    
    gdf_continental = gdf_chile[~gdf_chile[COMUNA_COL].apply(is_excluded_comuna)].copy()
    
    comuna_asr_copy = comuna_asr.copy()
    comuna_asr_copy['comuna_norm'] = comuna_asr_copy['comuna'].apply(normalize_comuna_spatial)
    
    gdf_f84 = gdf_continental.merge(
        comuna_asr_copy[['comuna_norm', 'asr']], 
        on='comuna_norm', 
        how='left'
    ).rename(columns={'asr': 'asr_f84'})
    
    gdf_f84['asr_f84'] = gdf_f84['asr_f84'].fillna(0)
    
    has_f84_data = gdf_f84['asr_f84'].sum() > 0
    has_spatial_data = True
    
    try:
        pesos = Queen.from_dataframe(gdf_f84)
    except:
        pesos = None
```

### Choropleth Map - Total F84 ASR

```{python}
#| label: fig-spatial-choropleth-national
#| fig-cap: "ASR Distribution - ASD (F84) - Chile Continental"
#| fig-width: 10
#| fig-height: 14

if has_spatial_data:
    fig, ax = plt.subplots(figsize=(10, 14))
    
    if has_f84_data:
        gdf_f84.plot(column='asr_f84', cmap='Blues', linewidth=0.3, ax=ax, edgecolor='0.7',
                    legend=True, legend_kwds={'label': 'ASR (per 100,000)', 'shrink': 0.5})
        ax.set_title('Autism Spectrum Disorders (F84) - ASR by Comuna\nChile Continental', fontweight='bold', fontsize=12)
    else:
        gdf_f84.plot(ax=ax, color='lightgrey', edgecolor='0.5', linewidth=0.3)
        ax.set_title('F84 codes - No data', fontweight='bold', fontsize=12)
    ax.set_axis_off()
    
    plt.suptitle('Age-Standardized Hospitalization Rates (2019-2024)\nExcluding Isla de Pascua, Juan Fernández, Antártica', 
                 fontsize=14, fontweight='bold', y=0.98)
    plt.tight_layout()
    save_figure(fig, 'spatial_choropleth_national_f84.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Shapefile not available', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

### Choropleth Maps by F84 Subcode

```{python}
#| label: fig-spatial-choropleth-by-subcode
#| fig-cap: "ASR Distribution by F84 Subcode - Chile Continental"
#| fig-width: 18
#| fig-height: 20

if has_spatial_data:
    disease_labels = {
        'F84': ('Pervasive developmental disorders', 'Blues'),
        'F84.0': ('Childhood autism', 'Reds'),
        'F84.1': ('Atypical autism', 'Oranges'),
        'F84.2': ('Rett syndrome', 'Purples'),
        'F84.3': ('Childhood disintegrative disorder', 'Greens'),
        'F84.4': ('Overactive disorder with MR', 'YlOrBr'),
        'F84.5': ('Asperger syndrome', 'RdPu'),
        'F84.8': ('Other PDD', 'BuGn'),
        'F84.9': ('PDD unspecified', 'GnBu')
    }
    
    icd_codes_with_data = []
    gdf_by_icd = {}
    
    for icd in icd_codes_present:
        if icd in comuna_asr_by_icd and len(comuna_asr_by_icd[icd]) > 0:
            asr_data = comuna_asr_by_icd[icd].copy()
            asr_data = asr_data[~asr_data['comuna'].apply(is_excluded_comuna)]
            if len(asr_data) > 0 and asr_data['asr'].sum() > 0:
                asr_data['comuna_norm'] = asr_data['comuna'].apply(normalize_comuna_spatial)
                gdf_icd = gdf_continental.copy()
                gdf_icd = gdf_icd.merge(
                    asr_data[['comuna_norm', 'asr']], 
                    on='comuna_norm', 
                    how='left'
                )
                gdf_icd['asr'] = gdf_icd['asr'].fillna(0)
                gdf_by_icd[icd] = gdf_icd
                icd_codes_with_data.append(icd)
    
    n_codes = len(icd_codes_with_data)
    
    if n_codes > 0:
        ncols = 3
        nrows = max(1, (n_codes + ncols - 1) // ncols)
        
        fig, axes = plt.subplots(nrows, ncols, figsize=(18, 6*nrows))
        axes = axes.flatten() if n_codes > 1 else [axes]
        
        for idx, icd in enumerate(icd_codes_with_data):
            ax = axes[idx]
            gdf = gdf_by_icd[icd]
            label, cmap = disease_labels.get(icd, (icd, 'viridis'))
            
            gdf.plot(column='asr', cmap=cmap, linewidth=0.2, ax=ax, edgecolor='0.7',
                     legend=True, legend_kwds={'label': 'ASR', 'shrink': 0.4, 'pad': 0.01})
            ax.set_title(f'{icd}: {label[:30]}', fontweight='bold', fontsize=10)
            ax.set_axis_off()
        
        for idx in range(len(icd_codes_with_data), len(axes)):
            axes[idx].set_visible(False)
        
        plt.suptitle('F84 Subcode-Specific ASR Distribution - Chile Continental (2019-2024)', 
                     fontsize=14, fontweight='bold', y=1.01)
        plt.tight_layout()
        save_figure(fig, 'spatial_choropleth_by_subcode_f84.png')
        plt.show()
    else:
        fig, ax = plt.subplots(figsize=(8, 6))
        ax.text(0.5, 0.5, 'No subcode data available for mapping', ha='center', va='center', fontsize=14)
        ax.set_axis_off()
        plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Spatial data not available', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

\newpage

### Global Moran's I - Spatial Autocorrelation

```{python}
#| label: spatial-moran-global-national
#| include: false

moran_f84 = None
moran_by_icd = {}

if has_spatial_data and pesos is not None:
    if has_f84_data and gdf_f84['asr_f84'].var() > 0:
        try:
            moran_f84 = Moran(gdf_f84['asr_f84'], pesos)
        except:
            moran_f84 = None
    
    for icd in icd_codes_with_data:
        gdf = gdf_by_icd[icd]
        if gdf['asr'].var() > 0:
            try:
                moran_by_icd[icd] = Moran(gdf['asr'], pesos)
            except:
                pass
```

```{python}
#| label: tbl-moran-global-national
#| tbl-cap: "Global Moran's I - Spatial Autocorrelation Test (Chile Continental)"
#| tbl-cap-location: bottom

moran_results = []

if moran_f84 is not None:
    moran_results.append({
        'Variable': 'Total F84',
        "Moran's I": round(moran_f84.I, 4),
        'E[I]': round(moran_f84.EI, 4),
        'Z-score': round(moran_f84.z_norm, 4),
        'P-value': round(moran_f84.p_norm, 4),
        'Interpretation': 'Clustered' if moran_f84.I > 0 and moran_f84.p_norm < 0.05 else ('Dispersed' if moran_f84.I < 0 and moran_f84.p_norm < 0.05 else 'Random')
    })

for icd in moran_by_icd:
    m = moran_by_icd[icd]
    moran_results.append({
        'Variable': icd,
        "Moran's I": round(m.I, 4),
        'E[I]': round(m.EI, 4),
        'Z-score': round(m.z_norm, 4),
        'P-value': round(m.p_norm, 4),
        'Interpretation': 'Clustered' if m.I > 0 and m.p_norm < 0.05 else ('Dispersed' if m.I < 0 and m.p_norm < 0.05 else 'Random')
    })

if moran_results:
    moran_df = pd.DataFrame(moran_results)
    display(moran_df.style.format({
        "Moran's I": '{:.4f}',
        'E[I]': '{:.4f}',
        'Z-score': '{:.4f}',
        'P-value': '{:.4f}'
    }).hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['Insufficient data for Moran analysis']}).style.hide(axis="index"))
```

```{python}
#| label: fig-moran-scatterplot-national
#| fig-cap: "Moran Scatterplot - Spatial Autocorrelation Visualization"
#| fig-width: 8
#| fig-height: 6

fig, ax = plt.subplots(figsize=(8, 6))

if moran_f84 is not None:
    moran_scatterplot(moran_f84, zstandard=True, ax=ax)
    ax.set_title(f"Total F84 - Moran's I = {moran_f84.I:.4f} (p = {moran_f84.p_norm:.4f})", fontweight='bold')
else:
    ax.text(0.5, 0.5, 'Insufficient F84 data\nfor Moran analysis', ha='center', va='center', transform=ax.transAxes, fontsize=12)
    ax.set_title('ASD codes (F84)', fontweight='bold')

plt.suptitle("Global Moran's I - Spatial Autocorrelation (Chile Continental)", fontsize=14, fontweight='bold', y=1.02)
plt.tight_layout()
save_figure(fig, 'moran_scatterplot_national_f84.png')
plt.show()
```

\newpage

### LISA - Local Indicators of Spatial Association

```{python}
#| label: lisa-calculation-national
#| include: false

def clasificar_lisa(lisa, data):
    significativo = lisa.p_sim < 0.05
    q = lisa.q
    cluster_labels = ['Not significant'] * len(data)
    for i in range(len(data)):
        if significativo[i]:
            if q[i] == 1: 
                cluster_labels[i] = 'High-High (Hot Spot)'
            elif q[i] == 2: 
                cluster_labels[i] = 'Low-High'
            elif q[i] == 3: 
                cluster_labels[i] = 'Low-Low (Cold Spot)'
            elif q[i] == 4: 
                cluster_labels[i] = 'High-Low'
    return cluster_labels

lisa_f84 = None
lisa_by_icd = {}

if has_spatial_data and pesos is not None:
    if has_f84_data and gdf_f84['asr_f84'].var() > 0:
        try:
            lisa_f84 = Moran_Local(gdf_f84['asr_f84'], pesos)
            gdf_f84['cluster_f84'] = clasificar_lisa(lisa_f84, gdf_f84)
            gdf_f84['lisa_p_f84'] = lisa_f84.p_sim
        except:
            gdf_f84['cluster_f84'] = 'No data'
            gdf_f84['lisa_p_f84'] = 1.0
    else:
        gdf_f84['cluster_f84'] = 'No data'
        gdf_f84['lisa_p_f84'] = 1.0
    
    for icd in icd_codes_with_data:
        gdf = gdf_by_icd[icd]
        if gdf['asr'].var() > 0:
            try:
                lisa = Moran_Local(gdf['asr'], pesos)
                gdf_by_icd[icd]['cluster'] = clasificar_lisa(lisa, gdf)
                gdf_by_icd[icd]['lisa_p'] = lisa.p_sim
                lisa_by_icd[icd] = lisa
            except:
                gdf_by_icd[icd]['cluster'] = 'No data'
                gdf_by_icd[icd]['lisa_p'] = 1.0
```

```{python}
#| label: tbl-lisa-clusters-f84-national
#| tbl-cap: "LISA Clusters - Total F84 - Chile Continental"
#| tbl-cap-location: bottom

if has_spatial_data and 'cluster_f84' in gdf_f84.columns:
    clusters_f84 = gdf_f84.groupby('cluster_f84').size().reset_index(name='N Comunas')
    clusters_f84.columns = ['Cluster', 'N Comunas']
    clusters_f84 = clusters_f84.sort_values('N Comunas', ascending=False)
    display(clusters_f84.style.hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['No spatial data available']}).style.hide(axis="index"))
```

```{python}
#| label: fig-lisa-maps-national
#| fig-cap: "LISA Cluster Map - Total F84 - Chile Continental"
#| fig-width: 10
#| fig-height: 14

colors_dict = {
    'High-High (Hot Spot)': '#d73027',
    'Low-Low (Cold Spot)': '#4575b4',
    'High-Low': '#fdae61',
    'Low-High': '#abd9e9',
    'Not significant': '#f0f0f0',
    'No data': '#d9d9d9'
}

if has_spatial_data and 'cluster_f84' in gdf_f84.columns:
    fig, ax = plt.subplots(figsize=(10, 14))
    
    gdf_f84.plot(ax=ax, color=gdf_f84['cluster_f84'].map(colors_dict), edgecolor='gray', linewidth=0.3)
    ax.set_title('LISA Clusters - Total F84\nChile Continental', fontsize=12, fontweight='bold')
    ax.set_axis_off()
    
    legend_elements = [Patch(facecolor=color, edgecolor='black', label=label) 
                       for label, color in colors_dict.items() if label != 'No data']
    fig.legend(handles=legend_elements, loc='lower center', ncol=5, fontsize=9, 
               frameon=True, bbox_to_anchor=(0.5, 0.02))
    
    plt.suptitle('Local Indicators of Spatial Association (LISA)\nASR (2019-2024)', 
                 fontsize=14, fontweight='bold', y=0.98)
    plt.tight_layout()
    save_figure(fig, 'lisa_clusters_national_f84.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Spatial data not available', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

### LISA Clusters by F84 Subcode

```{python}
#| label: fig-lisa-by-subcode
#| fig-cap: "LISA Cluster Maps by F84 Subcode"
#| fig-width: 18
#| fig-height: 20

if has_spatial_data and len(lisa_by_icd) > 0:
    icd_with_lisa = [icd for icd in icd_codes_with_data if icd in lisa_by_icd]
    n_codes = len(icd_with_lisa)
    
    if n_codes > 0:
        ncols = 3
        nrows = max(1, (n_codes + ncols - 1) // ncols)
        
        fig, axes = plt.subplots(nrows, ncols, figsize=(18, 6*nrows))
        axes = axes.flatten() if n_codes > 1 else [axes]
        
        for idx, icd in enumerate(icd_with_lisa):
            ax = axes[idx]
            gdf = gdf_by_icd[icd]
            label = ALL_ASD_CODES.get(icd, icd)[:30]
            
            gdf.plot(ax=ax, color=gdf['cluster'].map(colors_dict), edgecolor='gray', linewidth=0.2)
            ax.set_title(f'{icd}: {label}', fontweight='bold', fontsize=10)
            ax.set_axis_off()
        
        for idx in range(len(icd_with_lisa), len(axes)):
            axes[idx].set_visible(False)
        
        legend_elements = [Patch(facecolor=color, edgecolor='black', label=label) 
                           for label, color in colors_dict.items() if label != 'No data']
        fig.legend(handles=legend_elements, loc='lower center', ncol=5, fontsize=9, 
                   frameon=True, bbox_to_anchor=(0.5, 0.01))
        
        plt.suptitle('LISA Clusters by F84 Subcode - Chile Continental (2019-2024)', 
                     fontsize=14, fontweight='bold', y=1.01)
        plt.tight_layout()
        save_figure(fig, 'lisa_clusters_by_subcode_f84.png')
        plt.show()
    else:
        fig, ax = plt.subplots(figsize=(8, 6))
        ax.text(0.5, 0.5, 'No LISA data available', ha='center', va='center', fontsize=14)
        ax.set_axis_off()
        plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Spatial data not available', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

```{python}
#| label: tbl-lisa-hotspots-national
#| tbl-cap: "Significant LISA Clusters - Comunas Detail (Total F84)"
#| tbl-cap-location: bottom

if has_spatial_data and 'cluster_f84' in gdf_f84.columns:
    significant_clusters = gdf_f84[
        gdf_f84['cluster_f84'] != 'Not significant'
    ][[COMUNA_COL, 'asr_f84', 'cluster_f84', 'lisa_p_f84']].copy()
    significant_clusters.columns = ['Comuna', 'ASR F84', 'Cluster', 'P-value']
    significant_clusters = significant_clusters.sort_values('ASR F84', ascending=False)
    
    display(significant_clusters.style.format({
        'ASR F84': '{:.2f}',
        'P-value': '{:.4f}'
    }, na_rep='-').hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['No significant clusters found']}).style.hide(axis="index"))
```

### Spatial Analysis Summary by Subcode

```{python}
#| label: tbl-spatial-summary-by-subcode
#| tbl-cap: "Spatial Analysis Summary by F84 Subcode"
#| tbl-cap-location: bottom

if has_spatial_data:
    summary_data = []
    
    summary_data.append({
        'ICD': 'Total F84',
        'Comunas with Data': (gdf_f84['asr_f84'] > 0).sum(),
        'Mean ASR': gdf_f84['asr_f84'].mean().round(2),
        "Moran's I": round(moran_f84.I, 4) if moran_f84 else None,
        'P-value': round(moran_f84.p_norm, 4) if moran_f84 else None,
        'Pattern': 'Clustered' if moran_f84 and moran_f84.I > 0 and moran_f84.p_norm < 0.05 else 'Random',
        'Hot Spots': (gdf_f84['cluster_f84'] == 'High-High (Hot Spot)').sum() if 'cluster_f84' in gdf_f84.columns else 0,
        'Cold Spots': (gdf_f84['cluster_f84'] == 'Low-Low (Cold Spot)').sum() if 'cluster_f84' in gdf_f84.columns else 0
    })
    
    for icd in icd_codes_with_data:
        gdf = gdf_by_icd[icd]
        m = moran_by_icd.get(icd)
        summary_data.append({
            'ICD': icd,
            'Comunas with Data': (gdf['asr'] > 0).sum(),
            'Mean ASR': gdf['asr'].mean().round(2),
            "Moran's I": round(m.I, 4) if m else None,
            'P-value': round(m.p_norm, 4) if m else None,
            'Pattern': 'Clustered' if m and m.I > 0 and m.p_norm < 0.05 else 'Random',
            'Hot Spots': (gdf['cluster'] == 'High-High (Hot Spot)').sum() if 'cluster' in gdf.columns else 0,
            'Cold Spots': (gdf['cluster'] == 'Low-Low (Cold Spot)').sum() if 'cluster' in gdf.columns else 0
        })
    
    summary_df = pd.DataFrame(summary_data)
    display(summary_df.style.format({
        'Mean ASR': '{:.2f}',
        "Moran's I": '{:.4f}',
        'P-value': '{:.4f}'
    }, na_rep='-').hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['Spatial analysis not available']}).style.hide(axis="index"))
```

\newpage

## Regional Comunal Maps

```{python}
#| label: regional-maps-setup
#| include: false

if has_spatial_data and REGION_CODE_COL:
    regions_in_data = gdf_continental[REGION_CODE_COL].dropna().unique()
    regions_in_data = sorted([int(r) for r in regions_in_data if pd.notna(r)])
else:
    regions_in_data = []
```

```{python}
#| label: fig-regional-comunas-maps
#| fig-cap: "ASR by Comuna - Regional Maps"
#| fig-width: 20
#| fig-height: 24
if has_spatial_data and REGION_CODE_COL and len(regions_in_data) > 0:
    # Excluir región 0 (datos sin asignar o valor por defecto)
    regions_in_data_valid = [r for r in regions_in_data if r != 0]
    
    n_regions = len(regions_in_data_valid)
    ncols = 4
    nrows = max(1, (n_regions + ncols - 1) // ncols)
    
    fig, axes = plt.subplots(nrows, ncols, figsize=(20, 6*nrows))
    axes = axes.flatten()
    
    for idx, reg_code in enumerate(regions_in_data_valid):
        ax = axes[idx]
        gdf_region = gdf_f84[gdf_f84[REGION_CODE_COL] == reg_code].copy()
        
        if len(gdf_region) > 0:
            region_name = REGION_CODES.get(reg_code, f'Region {reg_code}')
            
            if gdf_region['asr_f84'].sum() > 0:
                gdf_region.plot(column='asr_f84', cmap='Blues', linewidth=0.5, ax=ax, 
                               edgecolor='0.5', legend=True, 
                               legend_kwds={'label': 'ASR', 'shrink': 0.6, 'pad': 0.02})
            else:
                gdf_region.plot(ax=ax, color='lightgrey', edgecolor='0.5', linewidth=0.5)
            
            ax.set_title(f'{region_name}', fontweight='bold', fontsize=10)
            ax.set_axis_off()
        else:
            ax.set_visible(False)
    
    for idx in range(len(regions_in_data_valid), len(axes)):
        axes[idx].set_visible(False)
    
    plt.suptitle('Age-Standardized Rates (F84) by Comuna - Regional View (2019-2024)', 
                 fontsize=16, fontweight='bold', y=1.01)
    plt.tight_layout()
    save_figure(fig, 'regional_comunas_maps_f84.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Regional shapefile data not available', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

### Regional Detail Tables

```{python}
#| label: tbl-regional-comunas-summary
#| tbl-cap: "Top 5 Comunas by ASR per Region"
#| tbl-cap-location: bottom

if has_spatial_data and REGION_CODE_COL:
    regional_top_comunas = []
    
    for reg_code in regions_in_data:
        gdf_region = gdf_f84[gdf_f84[REGION_CODE_COL] == reg_code].copy()
        gdf_region = gdf_region[gdf_region['asr_f84'] > 0]
        
        if len(gdf_region) > 0:
            region_name = REGION_CODES.get(reg_code, f'Region {reg_code}')
            top5 = gdf_region.nlargest(5, 'asr_f84')[[COMUNA_COL, 'asr_f84']]
            
            for _, row in top5.iterrows():
                regional_top_comunas.append({
                    'Region': region_name,
                    'Comuna': row[COMUNA_COL],
                    'ASR': row['asr_f84']
                })
    
    if regional_top_comunas:
        top_comunas_df = pd.DataFrame(regional_top_comunas)
        display(top_comunas_df.style.format({'ASR': '{:.2f}'}).hide(axis="index"))
    else:
        display(pd.DataFrame({'Message': ['No data available']}).style.hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['Regional data not available']}).style.hide(axis="index"))
```

\newpage

## Summary Statistics

```{python}
#| label: tbl-overall-summary
#| tbl-cap: "Overall Analysis Summary"
#| tbl-cap-location: bottom

total_hosp = hospitalizations['hospitalizations'].sum()
total_years = len(hospitalizations['year'].unique())
unique_codes = hospitalizations['icd_code'].nunique()

sex_totals = hospitalizations.groupby('sex')['hospitalizations'].sum()
male_total = sex_totals.get('Male', 0)
female_total = sex_totals.get('Female', 0)

most_common = hospitalizations.groupby('icd_code')['hospitalizations'].sum().idxmax()
most_common_desc = ALL_ASD_CODES.get(most_common, most_common)

summary_stats = pd.DataFrame({
    'Metric': [
        'Total Hospitalizations',
        'Years Analyzed',
        'Unique ICD-10 Codes (F84.x)',
        'Male Hospitalizations',
        'Female Hospitalizations',
        'Male:Female Ratio',
        'Most Common Diagnosis',
        'Average Annual Hospitalizations',
        'Regions Analyzed',
        'Comunas Analyzed (Continental)'
    ],
    'Value': [
        f'{total_hosp:,.0f}',
        total_years,
        unique_codes,
        f'{male_total:,.0f}',
        f'{female_total:,.0f}',
        f'{male_total/female_total:.2f}' if female_total > 0 else 'N/A',
        f'{most_common} - {most_common_desc}',
        f'{total_hosp/total_years:,.0f}',
        regional_data['region'].nunique(),
        len(total_by_comuna)
    ]
})

summary_stats.style.hide(axis="index")
```

```{python}
#| label: fig-summary-dashboard
#| fig-cap: "Autism Spectrum Disorders (F84) - Summary Dashboard"
#| fig-width: 16
#| fig-height: 12

fig, axes = plt.subplots(2, 3, figsize=(16, 12))

ax1 = axes[0, 0]
yearly_total = hospitalizations.groupby('year')['hospitalizations'].sum()
ax1.plot(yearly_total.index, yearly_total.values, marker='o', linewidth=3, color='darkgreen')
ax1.fill_between(yearly_total.index, yearly_total.values, alpha=0.3, color='green')
ax1.set_xlabel('Year')
ax1.set_ylabel('Hospitalizations')
ax1.set_title('Total Hospitalizations Trend', fontweight='bold')
ax1.grid(True, alpha=0.3)

ax2 = axes[0, 1]
icd_totals = hospitalizations.groupby('icd_code')['hospitalizations'].sum().sort_values(ascending=False)
colors = plt.cm.Set2(np.linspace(0, 1, len(icd_totals)))
ax2.pie(icd_totals.values, labels=icd_totals.index, autopct='%1.1f%%', colors=colors)
ax2.set_title('Distribution by F84 Subcode', fontweight='bold')

ax3 = axes[0, 2]
sex_totals = hospitalizations.groupby('sex')['hospitalizations'].sum()
ax3.bar(sex_totals.index, sex_totals.values, color=['steelblue', 'coral'])
ax3.set_ylabel('Hospitalizations')
ax3.set_title('Hospitalizations by Sex', fontweight='bold')
ax3.grid(True, alpha=0.3, axis='y')

ax4 = axes[1, 0]
age_dist = hospitalizations.groupby('age_group')['hospitalizations'].sum()
age_dist = age_dist.reindex([a for a in AGE_ORDER if a in age_dist.index])
ax4.bar(age_dist.index, age_dist.values, color='teal', alpha=0.7)
ax4.set_xlabel('Age Group')
ax4.set_ylabel('Hospitalizations')
ax4.set_title('Age Distribution', fontweight='bold')
ax4.tick_params(axis='x', rotation=45)
ax4.grid(True, alpha=0.3, axis='y')

ax5 = axes[1, 1]
top_diag = hospitalizations.groupby('icd_code')['hospitalizations'].sum().nlargest(10)
top_labels = [ALL_ASD_CODES.get(c, c)[:25] for c in top_diag.index]
ax5.barh(top_labels, top_diag.values, color=plt.cm.viridis(np.linspace(0.2, 0.8, 10)))
ax5.set_xlabel('Hospitalizations')
ax5.set_title('Top Diagnoses (F84.x)', fontweight='bold')
ax5.grid(True, alpha=0.3, axis='x')

ax6 = axes[1, 2]
width = 0.35
x = np.arange(len(asr_sex_cols))
ax6.bar(x - width/2, asr_sex_cols['asr_male'], width, label='Male', color='steelblue')
ax6.bar(x + width/2, asr_sex_cols['asr_female'], width, label='Female', color='coral')
ax6.set_xlabel('Year')
ax6.set_ylabel('ASR (per 100,000)')
ax6.set_title('ASR Comparison by Sex', fontweight='bold')
ax6.set_xticks(x)
ax6.set_xticklabels(asr_sex_cols['year'])
ax6.legend()
ax6.grid(True, alpha=0.3, axis='y')

plt.suptitle('Autism Spectrum Disorders (F84) in Chile - Summary Dashboard (2019-2024)', 
             fontsize=16, fontweight='bold', y=1.02)
plt.tight_layout()
save_figure(fig, 'f84_summary_dashboard.png')
plt.show()
```

\newpage

## ICD-10 Code Reference

```{python}
#| label: tbl-icd-reference
#| tbl-cap: "ICD-10 Codes for Autism Spectrum Disorders (F84)"
#| tbl-cap-location: bottom

icd_ref = pd.DataFrame([
    {'ICD Code': k, 'Description': v} for k, v in ASD_CODES_F84.items()
])

icd_ref = icd_ref.sort_values('ICD Code')

icd_ref.style.hide(axis="index")
```
